https://github.com/microsoft/qlib/blob/main/qlib/backtest/backtest.py#L22
## `PORT_METRIC` and `INDICATOR_METRIC` Structure

### Type Definitions

```python
PORT_METRIC = Dict[str, Tuple[pd.DataFrame, dict]]
INDICATOR_METRIC = Dict[str, Tuple[pd.DataFrame, Indicator]]
```

### Overview

Both `PORT_METRIC` and `INDICATOR_METRIC` are dictionaries that store backtest results for different execution frequencies (e.g., `"day"`, `"30min"`, `"1min"`). Each entry contains a tuple with two elements: a **DataFrame** for time-series analysis and a **detailed object** for in-depth inspection.

---

## `PORT_METRIC` Structure

```python
PORT_METRIC = {
    "day": (
        pd.DataFrame,  # Portfolio metrics time series
        dict           # Historical position snapshots
    ),
    "30min": (
        pd.DataFrame,  # Portfolio metrics at 30-minute granularity
        dict           # Position snapshots at 30-minute intervals
    ),
    # ... other frequencies
}
```

### First Element: `pd.DataFrame` (Portfolio Metrics Time Series)

Generated by `PortfolioMetrics.generate_portfolio_metrics_dataframe()`.

**Columns:**

| Column | Description |
|--------|-------------|
| `account` | Total account value (cash + stock value) |
| `return` | Portfolio return rate (including transaction costs) |
| `total_turnover` | Cumulative turnover |
| `turnover` | Turnover rate for the period |
| `total_cost` | Cumulative transaction costs |
| `cost` | Transaction cost rate for the period |
| `value` | Total stock value |
| `cash` | Cash in account |
| `bench` | Benchmark return rate |

**Example:**
```python
            account   return  total_turnover  turnover  total_cost    cost   value       cash   bench
2026-02-17  1000000   0.0000               0    0.0000           0  0.0000       0  1000000.0  0.0000
2026-02-18  1005000   0.0050           50000    0.0500         100  0.0001   50000   995000.0  0.0030
2026-02-19  1012000   0.0070          120000    0.0700         250  0.0001  120000   892000.0  0.0050
2026-02-20  1008000  -0.0040          170000    0.0500         350  0.0001   80000   928000.0 -0.0020
```

### Second Element: `dict` (Position Snapshots)

Contains historical position snapshots from `Account.get_hist_positions()`.

**Structure:**
```python
{
    "positions": {
        pd.Timestamp("2026-02-17"): Position({...}),  # Position at day start/end
        pd.Timestamp("2026-02-18"): Position({...}),
        # ... more timestamps
    }
}
```

**Position Object Example:**
```python
Position({
    'SH600000': {'amount': 5000, 'price': 10.5, 'weight': 0.05, 'count_day': 1},
    'SH600001': {'amount': 3000, 'price': 20.3, 'weight': 0.07, 'count_day': 1},
    'cash': 892000.0,
    'now_account_value': 1012000.0
})
```

---

## `INDICATOR_METRIC` Structure

```python
INDICATOR_METRIC = {
    "day": (
        pd.DataFrame,  # Trade indicators time series
        Indicator      # Complete Indicator object with detailed data
    ),
    "30min": (
        pd.DataFrame,  # Trade indicators at 30-minute granularity
        Indicator      # Indicator object for 30-minute level
    ),
    # ... other frequencies
}
```

### First Element: `pd.DataFrame` (Trade Indicators Time Series)

Generated by `Indicator.generate_trade_indicators_dataframe()` from `trade_indicator_his`.

**Columns:**

| Column | Description |
|--------|-------------|
| `ffr` | Fulfill rate (weighted average) |
| `pa` | Price advantage (weighted average, in basis points) |
| `pos` | Positive rate (percentage of stocks with positive PA) |
| `deal_amount` | Total trading volume |
| `value` | Total trading value |
| `count` | Number of stocks traded in this period |

**Example:**
```python
            ffr    pa   pos  deal_amount    value  count
2026-02-17  0.95  0.002  0.6       1000.0  10500.0      1
2026-02-18  0.98  0.003  0.7       1500.0  16200.0      2
2026-02-19  0.92 -0.001  0.4        800.0   8800.0      1
2026-02-20  0.96  0.004  0.8       1200.0  12960.0      2
```

### Second Element: `Indicator` Object (Complete Indicator Data)

The `Indicator` object contains four main components:

```python
Indicator {
    # Current step data (last step of the backtest)
    "order_indicator": NumpyOrderIndicator,      # Per-stock detailed metrics for last step
    "trade_indicator": Dict[str, BaseSingleMetric],  # Portfolio-level metrics for last step
    
    # Historical snapshots (all steps)
    "order_indicator_his": OrderedDict,          # Per-stock details for each historical step
    "trade_indicator_his": OrderedDict           # Portfolio metrics for each historical step
}
```

#### 1. `order_indicator` (Current Step Per-Stock Metrics)

```python
NumpyOrderIndicator({
    "deal_amount": SingleData({'SH600000': 250.0, 'SH600001': 450.0, 'SH600002': 500.0}),
    "trade_value": SingleData({'SH600000': 2670.0, 'SH600001': 9135.0, 'SH600002': 7500.0}),
    "trade_price": SingleData({'SH600000': 10.68, 'SH600001': 20.19, 'SH600002': 15.0}),
    "ffr": SingleData({'SH600000': 0.5, 'SH600001': 1.0, 'SH600002': 0.8}),
    "pa": SingleData({'SH600000': 0.0066, 'SH600001': 0.015, 'SH600002': -0.005}),
    "inner_amount": SingleData({'SH600000': 250.0, 'SH600001': 450.0, 'SH600002': 500.0}),
    "trade_dir": SingleData({'SH600000': 1, 'SH600001': 1, 'SH600002': 1}),  # 1=BUY
    "base_price": SingleData({'SH600000': 10.6, 'SH600001': 20.0, 'SH600002': 15.1}),
    "base_volume": SingleData({'SH600000': 2, 'SH600001': 1, 'SH600002': 1})
})
```

#### 2. `trade_indicator` (Current Step Portfolio Metrics)

```python
{
    "ffr": BaseSingleMetric(0.96),      # Weighted average fulfill rate
    "pa": BaseSingleMetric(0.004),       # Weighted average price advantage
    "pos": BaseSingleMetric(0.8),        # Positive rate (4/5 stocks positive)
    "deal_amount": BaseSingleMetric(1200.0),
    "value": BaseSingleMetric(12960.0),
    "count": BaseSingleMetric(2)
}
```

#### 3. `order_indicator_his` (Historical Per-Stock Snapshots)

```python
OrderedDict({
    pd.Timestamp("2026-02-17 09:30"): NumpyOrderIndicator({...}),  # Step 1 details
    pd.Timestamp("2026-02-17 10:00"): NumpyOrderIndicator({...}),  # Step 2 details
    pd.Timestamp("2026-02-17 10:30"): NumpyOrderIndicator({...}),  # Step 3 details
    pd.Timestamp("2026-02-17 11:00"): NumpyOrderIndicator({...})   # Step 4 details
})
```

#### 4. `trade_indicator_his` (Historical Portfolio Snapshots)

```python
OrderedDict({
    pd.Timestamp("2026-02-17 09:30"): {"ffr": 0.95, "pa": 0.002, ...},  # Step 1 summary
    pd.Timestamp("2026-02-17 10:00"): {"ffr": 0.98, "pa": 0.003, ...},  # Step 2 summary
    pd.Timestamp("2026-02-17 10:30"): {"ffr": 0.92, "pa": -0.001, ...}, # Step 3 summary
    pd.Timestamp("2026-02-17 11:00"): {"ffr": 0.96, "pa": 0.004, ...}   # Step 4 summary
})
```

---

## Summary Comparison

| Aspect | `PORT_METRIC` | `INDICATOR_METRIC` |
|--------|---------------|-------------------|
| **First Element** | Portfolio metrics DataFrame (account, return, cost, cash, bench) | Trade indicators DataFrame (ffr, pa, pos, deal_amount, value, count) |
| **Second Element** | `dict` with position snapshots | `Indicator` object with complete metrics |
| **DataFrame Source** | `PortfolioMetrics.generate_portfolio_metrics_dataframe()` | `Indicator.generate_trade_indicators_dataframe()` |
| **Detailed Object** | Position snapshots from `Account.get_hist_positions()` | Indicator object from `Account.get_trade_indicator()` |
| **Purpose** | Portfolio-level analysis (PnL, risk, asset allocation) | Execution quality analysis (FFR, PA, POS) |

### Access Patterns

```python
# Get results for daily frequency
portfolio_df, positions_dict = portfolio_dict["day"]
indicator_df, indicator_obj = indicator_dict["day"]

# Time series analysis
portfolio_df.plot(y=["account", "bench"])  # Compare portfolio vs benchmark
indicator_df.plot(y=["ffr", "pa"])         # Analyze execution quality trends

# Detailed inspection
positions = positions_dict["positions"]  # View position snapshots
last_step_details = indicator_obj["order_indicator"]  # Last step per-stock data
historical_details = indicator_obj["order_indicator_his"]  # All steps per-stock data
```
